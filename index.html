<div class="container">
  <h1>Epic Simple Pasteboard</h1>

  <div id="dropbox">
    <p>
      Drag files here<br>
    </p>
  </div>

  <div class="warning">
    <h4>
      You are not logged in.
    </h4>
    <p>
      You have to be logged in and the owner of this app in
      order to upload photos.
    </p>
  </div>

  <div id="last-upload">
    Uploading....
  </div>

  <div id="images" class="app-pane clearfix">
  </div>
</div>

<script type="text/template" id="images-template">
<div id="image-thumbs"></div>
</script>

<script type="text/template" id="image-template">
<div class="buttons">
  <a href="#"><i class="icon-th icon-2x"></i></a>
</div>
<div>
  <img src="<%= path %>">
</div>
</script>

<script type="text/template" id="thumb-template">
<a href="<%= path %>" class="thumbnail">
  <img src="<%= path %>">
</a>
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.0/backbone.localStorage-min.js"></script>

<script type="text/javascript" src="//revore.s3.amazonaws.com/vendor/jquery.filedrop-0.min.js"></script>
<script type="text/javascript" src="//revore.s3.amazonaws.com/vendor/dropbox-0.min.js"></script>

<style type="text/css">
  @import url("//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css");
/* line 3, app.sass */
ul {
  list-style: none;
}

/* line 6, app.sass */
h1 {
  margin-top: 0;
  text-align: center;
}

/* line 9, app.sass */
h2 {
  font-size: 18px;
}

/* line 14, app.sass */
.container {
  width: 600px;
  border: 1px solid #eeeeee;
  padding: 1em;
  margin-top: 1.5em;
  box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.2), 0 25px 50px 0 rgba(0, 0, 0, 0.15);
  margin-bottom: 8em;
}

/* line 22, app.sass */
#dropbox {
  padding: 1.5em;
  border: 1px dashed #cccccc;
  background-color: #eeeeee;
  margin-bottom: 1em;
  text-align: center;
}
/* line 28, app.sass */
#dropbox p {
  font-size: 18px;
  line-height: 20px;
  margin: 0;
}
/* line 32, app.sass */
#dropbox small {
  font-size: 12px;
  line-height: 12px;
}

/* line 36, app.sass */
#last-upload {
  display: none;
}

/* line 39, app.sass */
.image-thumb {
  margin-bottom: 1em;
}

/* line 42, app.sass */
.thumbnail {
  padding: 0;
  border: none;
  margin-left: auto;
  margin-right: auto;
  border-radius: 0;
}

/* line 49, app.sass */
#dropbox {
  display: none;
}

/* line 53, app.sass */
.viewer-owner #dropbox {
  display: block;
}

/* line 56, app.sass */
.warning {
  background-color: #eeeeee;
  border: 1px solid #dddddd;
  padding: 1em;
  margin-top: 2em;
}

/* line 63, app.sass */
.logged-in .warning {
  display: none;
}

</style>

<script type="text/javascript">
  // Generated by CoffeeScript 1.4.0
(function() {
  var Image, ImageView, Images, ImagesCollection, ImagesView, ThumbView, defaults, imagesView, logDebug, redoImageCollection, uploadBlob;

  logDebug = false;

  $.event.fix = (function(originalFix) {
    return function(event) {
      event = originalFix.apply(this, arguments);
      if (event.type.indexOf('copy') === 0 || event.type.indexOf('paste') === 0) {
        event.clipboardData = event.originalEvent.clipboardData;
      }
      return event;
    };
  })($.event.fix);

  defaults = {
    callback: $.noop,
    matchType: /image.*/
  };

  $.fn.pasteImageReader = function(options) {
    if (typeof options === "function") {
      options = {
        callback: options
      };
    }
    options = $.extend({}, defaults, options);
    return this.each(function() {
      var $this, element;
      element = this;
      $this = $(this);
      return $this.bind('paste', function(event) {
        var clipboardData, found;
        found = false;
        clipboardData = event.clipboardData;
        return Array.prototype.forEach.call(clipboardData.types, function(type, i) {
          var file, reader;
          if (found) {
            return;
          }
          if (type.match(options.matchType) || clipboardData.items[i].type.match(options.matchType)) {
            file = clipboardData.items[i].getAsFile();
            uploadBlob(file);
            reader = new FileReader();
            reader.onload = function(evt) {
              return options.callback.call(element, {
                dataURL: evt.target.result,
                event: evt,
                file: file,
                name: file.name
              });
            };
            reader.readAsDataURL(file);
            return found = true;
          }
        });
      });
    });
  };

  uploadBlob = function(blob) {
    var fd;
    if (logDebug) {
      console.log("uploadBlob: blob", blob);
    }
    fd = new FormData();
    fd.append("files", blob, "filename");
    return $.ajax({
      type: "POST",
      data: fd,
      url: "/files.json",
      cache: false,
      contentType: false,
      processData: false,
      success: function(data) {
        if (logDebug) {
          console.log("data", data);
        }
        return Images.add(data);
      }
    });
  };

  $("html").pasteImageReader(function(results) {
    if (logDebug) {
      console.log("show last upload");
    }
    return $("#last-upload").show();
  });

  Image = Backbone.Model.extend();

  ImagesCollection = Backbone.Collection.extend({
    model: Image,
    url: '/files.json',
    comparator: function(image) {
      var sortDate;
      sortDate = image.get("createdAt");
      return 0 - Date.parse(sortDate);
    }
  });

  redoImageCollection = function() {
    $("#last-upload").hide();
    Images.fetch();
    return Images.sort();
  };

  Images = new ImagesCollection([]);

  redoImageCollection();

  if (logDebug) {
    console.log("images", Images);
  }

  ThumbView = Backbone.View.extend({
    className: "image-thumb",
    template: _.template($('#thumb-template').html()),
    render: function() {
      if (logDebug) {
        console.log("render thumbview");
      }
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    },
    initialize: function() {
      if (logDebug) {
        console.log("init thumbview");
      }
      return this.listenTo(this.model, 'change', this.render);
    }
  });

  ImageView = Backbone.View.extend({
    el: '#image',
    className: "app-pane",
    imageTemplate: _.template($('#image-template').html()),
    render: function() {
      if (logDebug) {
        console.log("render imageview");
      }
      this.$el.html(this.imageTemplate(this.model.toJSON()));
      return this;
    },
    initialize: function() {
      if (logDebug) {
        console.log("init imageview");
      }
      return this.listenTo(this.model, 'change', this.render);
    }
  });

  ImagesView = Backbone.View.extend({
    el: '#images',
    className: "app-pane",
    imagesTemplate: _.template($('#images-template').html()),
    render: function() {
      if (logDebug) {
        console.log("images view render", this.imagesTemplate());
      }
      $("#images").html(this.imagesTemplate());
      $("#image-thumbs").html("");
      this.$el.show();
      return this;
    },
    initialize: function() {
      if (logDebug) {
        console.log("images view initialize");
      }
      this.listenTo(Images, 'add', this.addAll);
      return this.redo();
    },
    redo: function() {
      this.render();
      return this.addAll();
    },
    addOne: function(image) {
      var view;
      if (logDebug) {
        console.log("image view add one", image);
      }
      view = new ThumbView({
        model: image
      });
      return $("#image-thumbs").append(view.render().el);
    },
    addAll: function() {
      if (logDebug) {
        console.log("image view add all", Images.length);
      }
      $("#image-thumbs").html('');
      return Images.each(this.addOne, this);
    }
  });

  imagesView = new ImagesView();

  $("title").text("Paste Board");

  setInterval(function() {
    return redoImageCollection();
  }, 1000);

}).call(this);
</script>
