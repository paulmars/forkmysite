<div id="gists">
  <h1>Gister</h1>
  <div class="composer clearfix">
    <form>
      <div class="form-group">
        <textarea class="form-control" name="code" id="code"></textarea>
      </div>
      <div class="form-group">
        <button id="save-button" type="submit" class="btn btn-default pull-right">Save</button>
      </div>
    </form>
  </div>
  <ul id="gists-list" class="list-unstyled">
  </ul>
</div>

<div id="code-view">
</div>

<script type="text/template" id="gist-template">
  <div class="view-controls">
    <a href="#" class="delete-gist"><i class="fa fa-trash-o"></i></a>
  </div>
  <pre><%= code %></pre>
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.10/backbone-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.0/backbone.localStorage-min.js
" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js"></script>

<style>
  @import url("//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css");
@import url("//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css");
/* line 4, app.sass */
#code-view {
  position: fixed;
  top: 0;
  bottom: 0;
  left: 50%;
  right: 0;
  background-color: white;
}

/* line 12, app.sass */
#gists {
  position: fixed;
  top: 0;
  bottom: 0;
  left: 5px;
  right: 51%;
  background-color: white;
  overflow: scroll;
}

/* line 21, app.sass */
.composer {
  margin-bottom: 20px;
}

/* line 24, app.sass */
.view-controls {
  float: right;
  padding-right: 5px;
  padding-top: 3px;
}

/* line 29, app.sass */
pre {
  cursor: pointer;
  cursor: hand;
}

</style>

<script>
  // Generated by CoffeeScript 1.6.3
(function() {
  var Gist, GistView, Gists, GistsCollection, GistsView, editor, logDebug;

  logDebug = false;

  Gist = Backbone.Model.extend({
    defaults: {
      code: ''
    }
  });

  GistsCollection = Backbone.Collection.extend({
    model: Gist,
    url: '/data/gists'
  });

  Gists = new GistsCollection([]);

  Gists.fetch();

  GistView = Backbone.View.extend({
    tagName: 'li',
    template: _.template($('#gist-template').html()),
    events: {
      'click .delete-gist': 'deleteGist',
      'click pre': 'viewCode'
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    },
    initialize: function() {
      return this.listenTo(this.model, 'change', this.render);
    },
    deleteGist: function() {
      if (logDebug) {
        console.log("delete gist", this.model);
      }
      return this.model.destroy();
    },
    viewCode: function() {
      if (logDebug) {
        console.log("view code", this.model);
      }
      return editor.setValue(this.model.get("code"), -1);
    }
  });

  GistsView = Backbone.View.extend({
    el: '#gists',
    events: {
      'click #save-button': 'createFromForm'
    },
    render: function() {
      if (logDebug) {
        console.log("lists view render", this.$el);
      }
      this.codeTextArea = $('#code');
      this.codeTextArea.focus();
      return this;
    },
    initialize: function() {
      if (logDebug) {
        console.log("lists view initialize");
      }
      this.listenTo(Gists, 'reset', this.addAll);
      this.listenTo(Gists, 'add', this.redo);
      this.listenTo(Gists, 'remove', this.redo);
      this.listenTo(Gists, 'create', this.redo);
      return this.redo();
    },
    redo: function() {
      this.render();
      return this.addAll();
    },
    addOne: function(gist) {
      var view;
      if (logDebug) {
        console.log("gist view add one", gist);
      }
      view = new GistView({
        model: gist
      });
      return $('#gists-list').append(view.render().el);
    },
    addAll: function() {
      if (logDebug) {
        console.log("list view add all", Gists.length);
      }
      $('#gists-list').html('');
      return Gists.each(this.addOne, this);
    },
    createFromForm: function() {
      var codeVal;
      if (logDebug) {
        console.log("createFromForm");
      }
      codeVal = this.codeTextArea.val();
      if (!codeVal) {
        if (logDebug) {
          console.log("codeVal", codeVal);
        }
        return false;
      }
      Gists.create({
        code: codeVal
      });
      this.codeTextArea.val("");
      return false;
    }
  });

  new GistsView();

  $("title").text("Gister");

  editor = ace.edit("code-view");

  editor.getSession();

  if (Gists.at(0)) {
    editor.setValue(Gists.at(0).get("code"), -1);
  }

}).call(this);

</script>
